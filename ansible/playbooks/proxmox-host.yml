# Playbook: Base Proxmox host configuration
# Scope: base OS hardening and utilities only; no storage, no VMs/LXCs.
# Safe to run repeatedly (idempotent) across multiple hosts on LAN-only SSH.
# Usage:
#   ansible-playbook -i inventory.yml playbooks/proxmox-host.yml

- name: Base configuration for Proxmox hosts
  hosts: proxmox_hosts
  become: true
  gather_facts: true

  pre_tasks:
    - name: Update package cache (keeps installs fast and current)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Check for authorized_keys to avoid lockout before hardening
      ansible.builtin.stat:
        path: "{{ authorized_keys_path }}"
      register: authorized_keys_stat

    - name: Stop if no SSH keys are present (prevents locking out)
      ansible.builtin.fail:
        msg: "Add at least one SSH public key to {{ authorized_keys_path }} before applying SSH hardening."
      when: not authorized_keys_stat.stat.exists or authorized_keys_stat.stat.size | default(0) == 0

  roles:
    - role: ssh_keys
    - role: admin_user
      when: admin_user_enabled | bool
    - role: node_exporter
      when: node_exporter_enabled | bool

  tasks:
    - name: Install essential base packages (tooling + time sync + certs)
      ansible.builtin.apt:
        name: "{{ base_packages }}"
        state: present

    - name: Ensure chrony service is enabled and running (time sync)
      ansible.builtin.service:
        name: chrony
        state: started
        enabled: true

    - name: (Optional) Set custom NTP servers for chrony
      ansible.builtin.debug:
        msg: "{{ chrony_note }}"
      # TODO: Add chrony.conf template once NTP sources are defined.

    - name: Harden SSH daemon for key-only access on LAN
      ansible.builtin.lineinfile:
        path: "{{ sshd_config_path }}"
        regexp: "^{{ item.option }}\\s"
        line: "{{ item.option }} {{ item.value }}"
        state: present
        create: false
        backrefs: false
      loop: "{{ sshd_settings }}"
      notify: Restart sshd

    - name: Ensure SSH daemon uses authorized_keys (avoid surprises)
      ansible.builtin.lineinfile:
        path: "{{ sshd_config_path }}"
        regexp: "^AuthorizedKeysFile\\s"
        line: "{{ sshd_authorized_keys_directive }}"
        state: present
        create: false
      notify: Restart sshd

    - name: Ensure SSH service is enabled
      ansible.builtin.service:
        name: ssh
        state: started
        enabled: true

    - name: Apply baseline sysctl settings (network + I/O safety)
      ansible.posix.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: true
      loop: "{{ sysctl_settings | dict2items }}"

    - name: Ensure journald persistent storage directory exists
      ansible.builtin.file:
        path: /var/log/journal
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Configure journald for persistent logging
      ansible.builtin.lineinfile:
        path: "{{ journald_conf_path }}"
        regexp: "^Storage="
        line: "Storage={{ journald_storage }}"
        state: present
        create: false
      notify: Restart journald

    - name: (Optional) Tune journald retention
      ansible.builtin.debug:
        msg: "{{ journald_retention_note }}"
      # TODO: Add retention limits when storage policy is defined.

  handlers:
    - name: Restart sshd
      ansible.builtin.service:
        name: ssh
        state: restarted

    - name: Restart journald
      ansible.builtin.service:
        name: systemd-journald
        state: restarted
